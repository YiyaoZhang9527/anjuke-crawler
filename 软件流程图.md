# 安居客爬虫程序运行流程图

## 🎯 完整程序运行流程

```mermaid
graph TB
    A[启动爬虫] --> B[加载.env配置文件]
    B --> C[初始化Playwright浏览器]
    C --> D{启用隐身模式?}
    D -->|是| E[设置反爬虫参数]
    D -->|否| F[常规浏览器设置]
    E --> G[配置代理设置]
    F --> G
    G --> H[生成区域化URL列表<br/>BASE_URL + TARGET_REGIONS]
    H --> I[准备CSV文件]
    I --> J[开始逐页处理循环]

    J --> K{还有页面且未达到总房源限制?}
    K -->|是| L[导航到列表页]
    K -->|否| M[生成统计报告]

    L --> N{页面加载成功?}
    N -->|否| O{重试次数<MAX_RETRY_TIMES?}
    O -->|是| P[延时RETRY_DELAY秒]
    P --> L
    O -->|否| Q[标记列表页失败]
    Q --> R[继续下一页]

    N -->|是| S[检测反爬验证]
    S --> T{有验证码?}
    T -->|是| U{启用自动验证?}
    U -->|是| V[尝试自动处理验证码]
    U -->|否| W[等待手动处理验证码]
    V --> X{验证处理成功?}
    W --> Y{验证处理完成?}
    X -->|否| Z[等待后重试]
    X -->|是| AA[页面加载延时]
    Y -->|否| AB[继续等待]
    Y -->|是| AA
    Z --> S
    AB --> Y
    T -->|否| AA

    AA --> BB[JavaScript提取房源链接]
    BB --> CC{提取到链接?}
    CC -->|否| DD[记录提取失败]
    DD --> R
    CC -->|是| EE[限制数量MAX_HOUSES_PER_PAGE]

    EE --> FF[开始处理房源详情]
    FF --> GG{还有房源且未达到总限制?}
    GG -->|是| HH[导航到房源详情页]
    GG -->|否| II[页面间延时3秒]

    HH --> JJ{详情页加载成功?}
    JJ -->|否| KK{重试次数<MAX_RETRY_TIMES?}
    KK -->|是| LL[延时RETRY_DELAY秒]
    LL --> HH
    KK -->|否| MM[标记详情页失败]
    MM --> NN[继续下一个房源]

    JJ -->|是| OO[检测反爬验证]
    OO --> PP{有验证码?}
    PP -->|是| QQ{启用自动验证?}
    QQ -->|是| RR[尝试自动处理验证码]
    QQ -->|否| SS[等待手动处理验证码]
    RR --> TT{验证处理成功?}
    SS --> UU{验证处理完成?}
    TT -->|否| VV[等待后重试]
    TT -->|是| WW[页面加载延时]
    UU -->|否| XX[继续等待]
    UU -->|是| WW
    VV --> OO
    XX --> UU
    PP -->|否| WW

    WW --> YY[JavaScript提取22个字段数据]
    YY --> ZZ{启用数据验证?}
    ZZ -->|否| AAA[直接保存数据]
    ZZ -->|是| BBB[价格范围检查<br/>MIN_PRICE~MAX_PRICE]
    BBB --> CCC{价格在范围内?}
    CCC -->|否| DDD[记录价格超范围]
    DDD --> EEE[跳过此房源]
    CCC -->|是| FFF[面积范围检查<br/>MIN_AREA~MAX_AREA]
    FFF --> GGG{面积在范围内?}
    GGG -->|否| HHH[记录面积超范围]
    HHH --> EEE
    GGG -->|是| AAA

    AAA --> III[写入CSV文件]
    III --> JJJ[更新成功计数]
    JJJ --> KKK[智能延时CRAWL_DELAY秒]
    KKK --> NN
    EEE --> LLL[更新失败计数]
    LLL --> KKK

    NN --> OO
    II --> R
    R --> K

    M --> NNN[关闭浏览器]
    NNN --> OOO[程序结束]
```

## 📊 核心控制流程

```mermaid
graph LR
    A[配置控制] --> A1[MAX_TOTAL_HOUSES总房源限制]
    A --> A2[MAX_PAGES页数限制]
    A --> A3[MAX_HOUSES_PER_PAGE每页限制]

    B[延时控制] --> B1[CRAWL_DELAY爬取间隔]
    B --> B2[PAGE_LOAD_DELAY页面加载延时]
    B --> B3[RETRY_DELAY重试延时]

    C[重试控制] --> C1[MAX_RETRY_TIMES最大重试次数]
    C --> C2[智能错误识别]
    C --> C3[递增延时策略]

    D[验证控制] --> D1[ENABLE_AUTO_VERIFICATION自动验证]
    D --> D2[VALIDATE_DATA数据验证]
    D --> D3[价格面积范围过滤]

    E[反爬控制] --> E1[ENABLE_STEALTH_MODE隐身模式]
    E --> E2[PROXY_LIST代理配置]
    E --> E3[User-Agent轮换]
```

## 🔄 反爬验证处理详情

```mermaid
graph TD
    A[页面加载完成] --> B[等待3秒检测]
    B --> C[检查页面元素]
    C --> D{存在验证元素?}
    D -->|否| E[正常流程]
    D -->|是| F{启用自动处理?}

    F -->|否| G[显示手动处理提示]
    G --> H[等待用户完成]
    H --> I{验证完成?}
    I -->|否| J[继续等待]
    I -->|是| E

    F -->|是| K[尝试自动点击]
    K --> L[等待验证完成]
    L --> M{验证成功?}
    M -->|是| E
    M -->|否| N{重试次数<3?}
    N -->|是| O[延时5秒重试]
    N -->|否| P[切换手动处理]
    O --> K
    P --> G
```

## 🎯 关键流程节点说明

### 1. **初始化阶段**
- 读取.env中25个配置项
- 根据ENABLE_STEALTH_MODE设置反爬参数
- 配置PROXY_LIST代理
- 生成BASE_URL+TARGET_REGIONS的URL列表

### 2. **列表页处理**
- 反爬验证检测和处理
- JavaScript提取房源链接
- 限制MAX_HOUSES_PER_PAGE个房源
- 失败重试机制

### 3. **详情页处理**
- 反爬验证检测和处理
- JavaScript提取22个字段
- 价格面积范围验证
- 写入CSV文件

### 4. **控制机制**
- MAX_TOTAL_HOUSES总房源数限制
- CRAWL_DELAY智能延时
- MAX_RETRY_TIMES重试机制
- 详细的进度日志

### 5. **反爬验证**
- 自动检测验证码元素
- 自动处理和手动处理两种模式
- 重试和降级策略

---

## 📋 配置项使用情况

✅ **全部25个.env配置项都已采用**，包括：
- 浏览器配置、爬取配置、输出配置
- 日志配置、反爬配置、数据验证配置
- 区域化URL生成和智能控制机制

整个程序实现了完整的"加载一页房源列表→爬取该页所有详情"工作流程，具备完善的反爬验证处理机制。